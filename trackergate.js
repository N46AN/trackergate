#!/usr/bin/env node
(function(){var p,q,k,g,f,r,m,s,t,e,l,u,n=function(b,a){return function(){return b.apply(a,arguments)}};s=require("https");r=require("dgram");m=require("fs");e=require("path");u=require("url");l=require("querystring");l.escape=escape;l.unescape=unescape;k=require("long");f=require("./config.json");f.httpsops={key:m.readFileSync(e.resolve(f.httpskey)),cert:m.readFileSync(e.resolve(f.httpscert))};p={"":0,completed:1,started:2,stopped:3};t=function(b){var a,d,c,h;d=b.split(".");if(4===d.length){b=c=0;for(h=d.length;c<h;b=++c){a=d[b];a=parseInt(a);if(isNaN(a)||0>a||255<a)return;d[b]=a}return new Buffer(d)}};g=function(b,a){var d,c,h;null==a&&(a=new Buffer(0));switch(typeof b){case "number":d="i"+b+"e";c=new Buffer(a.length+Buffer.byteLength(d));a.copy(c);c.write(d,a.length);break;case "string":d=Buffer.byteLength(b)+":"+b;c=new Buffer(a.length+Buffer.byteLength(d));a.copy(c);c.write(d,a.length,"binary");break;case "object":if(b instanceof Array){c=new Buffer(a.length+1);a.copy(c);c.write("l",a.length,"binary");a=c;c=0;for(h=b.length;c<h;c++)d=b[c],a=g(b[d],a);c=new Buffer(a.length+1);a.copy(c);c.write("e",a.length,"binary")}else if(b instanceof Buffer)d=b.length+":",c=new Buffer(a.length+Buffer.byteLength(d)+b.length),a.copy(c),c.write(d,a.length),b.copy(c,a.length+Buffer.byteLength(d));else{c=new Buffer(a.length+1);a.copy(c);c.write("d",a.length,"binary");a=c;for(d in b)a=g(d,a),a=g(b[d],a);c=new Buffer(a.length+1);a.copy(c);c.write("e",a.length,"binary")}}return c};q=function(){function b(a,d,c){this.req=a;this.res=d;this.trackergate=c;this.id=this.report(0);if(a=this.parseReq())return this.resError(400,a);if(a=this.authReq())return this.resError(403,a)}b.prototype.report=function(a){var d;d=Date.now();this.status=a;return this.trackergate.recReport(d,this)};b.prototype.parseReq=function(){var a;a=u.parse(this.req.url);e=a.pathname.split("/");if(5!==e.length||""!==e[0]||"announce"!==e[4])return"Invalid request path";this.gatewayauth=e[1];this.trackerhost=e[2];if(""===this.trackerhost)return"Invalid tracker hostname";this.trackerport=parseInt(e[3]);if(isNaN(this.trackerport)||0>this.trackerport||65535<this.trackerport)return"Invalid tracker port";this.annreq={};a=l.parse(a.query);this.annreq.infohash=new Buffer(a.info_hash||"","binary");if(20!==this.annreq.infohash.length)return"Invalid info hash";this.annreq.peerid=new Buffer(a.peer_id||"","binary");if(20!==this.annreq.peerid.length)return"Invalid peer ID";this.annreq.downloaded=k.fromString(a.downloaded||"-1");if(0>this.annreq.downloaded)return"Invalid downloaded bytes";this.annreq.left=k.fromString(a.left||"-1");if(0>this.annreq.left)return"Invalid left bytes";this.annreq.uploaded=k.fromString(a.uploaded||"-1");if(0>this.annreq.uploaded)return"Invalid uploaded bytes";this.annreq.event=p[a.event||""];if(void 0===this.annreq.event)return"Invalid announce event";this.annreq.ip=t(a.ip||this.req.connection.remoteAddress);if(void 0===this.annreq.ip)return"Invalid client IP";this.annreq.key=parseInt(a.key||"0",16);if(isNaN(this.annreq.key)||0>this.annreq.key||4294967295<this.annreq.key)return"Invalid announce key";this.annreq.numwant=parseInt(a.numwant||"-1");if(isNaN(this.annreq.numwant)||-1>this.annreq.numwant||2147483647<this.annreq.numwant)return"Invalid number of wanted peers";this.annreq.port=parseInt(a.port);if(isNaN(this.annreq.port)||0>this.annreq.numwant||65535<this.annreq.port)return"Invalid client port";console.log(">",this.id,this.req.connection.remoteAddress+":"+this.req.connection.remotePort,this.trackerhost+":"+this.trackerport,this.annreq.infohash.toString("hex"));return null};b.prototype.authReq=function(){return this.gatewayauth!==f.passkey?"Gateway authentication failed":null};b.prototype.reqConnect=function(){var a,d;a=new Buffer(16);a.write("0000041727101980",0,8,"hex");a.writeUInt32BE(0,8);a.writeUInt32BE(2*this.id,12);d=function(a){return function(){return a.report(1)}}(this);this.trackergate.udpserver.send(a,0,16,this.trackerport,this.trackerhost,d);return null};b.prototype.parseConnRes=function(a){if(16>a.length)return this.resError(502,"Invalid connect response from tracker");this.connid=new Buffer(8);a.copy(this.connid,0,8,16);return null};b.prototype.reqAnnounce=function(){var a,d;a=new Buffer(98);this.connid.copy(a,0);a.writeUInt32BE(1,8);a.writeUInt32BE(2*this.id+1,12);this.annreq.infohash.copy(a,16);this.annreq.peerid.copy(a,36);a.writeUInt32BE(this.annreq.downloaded.high,56);a.writeUInt32BE(this.annreq.downloaded.low,60);a.writeUInt32BE(this.annreq.left.high,64);a.writeUInt32BE(this.annreq.left.low,68);a.writeUInt32BE(this.annreq.uploaded.high,72);a.writeUInt32BE(this.annreq.uploaded.low,76);a.writeUInt32BE(this.annreq.event,80);this.annreq.ip.copy(a,84);a.writeUInt32BE(this.annreq.key,88);a.writeInt32BE(this.annreq.numwant,92);a.writeUInt16BE(this.annreq.port,96);d=function(a){return function(){return a.report(3)}}(this);this.trackergate.udpserver.send(a,0,98,this.trackerport,this.trackerhost,d);return null};b.prototype.parseAnnRes=function(a){var d;d=a.length-20;if(20>a.length||0!==d%6)return this.resError(502,"Invalid announce response from tracker");this.annres={};this.annres.interval=a.readUInt32BE(8);this.annres.incomplete=a.readUInt32BE(12);this.annres.complete=a.readUInt32BE(16);this.annres.peers=new Buffer(d);a.copy(this.annres.peers,0,20);return null};b.prototype.resAnnounce=function(){this.trackergate.endJob(this);this.res.writeHead(200);this.res.write(g(this.annres),"binary");this.res.end();this.report(5);console.log("<",this.id);return this.id};b.prototype.parseErrRes=function(a,d){this.trackererr=new Buffer(d.length-8);d.copy(this.trackererr,0,8);return null};b.prototype.resError=function(a,d){this.err=[a,d];this.res.writeHead(a,d);this.res.write(g({"failure reason":d}));this.res.end();this.report(6);console.log("!",this.id,a,d);return this.id};b.prototype.expireReq=function(a){this.trackergate.endJob(this);return this.resError(504,a)};return b}();(new (function(){function b(a,d,c,b){this.httpsops=a;this.httpsport=d;this.udpport=c;this.trackertimeout=b;this.tick=n(this.tick,this);this.resTracker=n(this.resTracker,this);this.resClient=n(this.resClient,this);this.jobqueue={};this.repqueue=[];this.httpsserver=s.createServer(a,this.resClient);this.udpserver=r.createSocket("udp4",this.resTracker)}b.prototype.genID=function(){for(var a;a=Math.floor(2147483648*Math.random()),a in this.jobqueue;);return a};b.prototype.recReport=function(a,d){var c,b,e;c=d.id;e=d.status;b=[a,c,e];this.repqueue.push(b);null==c&&(c=b[1]=this.genID());console.log((new Date(a)).toISOString(),c+":"+e);return c};b.prototype.endJob=function(a){return delete this.jobqueue[a.id]};b.prototype.resClient=function(a,d){var c;c=new q(a,d,this);if(c.err)return c.err;this.jobqueue[c.id]=c;c.reqConnect();return null};b.prototype.resTracker=function(a,d){var c,b;if(8>a.length)return"Tracker response too short";c=a.readUInt32BE(0);b=a.readUInt32BE(4);b=this.jobqueue[Math.floor(b/2)];if(!b)return"Tracker response not matching any client request";switch(c){case 0:b.report(2);b.parseConnRes(a);b.reqAnnounce();break;case 1:b.report(4);b.parseAnnRes(a);b.resAnnounce();break;case 2:return"scrape not yet implemented";case 3:b.parseErrRes(a),b.resError(500,"tracker error: "+b.trackererr)}return null};b.prototype.tick=function(){var a,b,c;a=Date.now();if(0===this.repqueue.length)return null;for(;a-this.repqueue[0][0]>=1E3*this.trackertimeout;){c=this.repqueue.shift();a=c[0];b=c[1];c=c[2];b=this.jobqueue[b];if(!b||b.status!==c)break;switch(c){case 1:return b.expireReq("tracker connect timeout");case 3:return b.expireReq("tracker announce timeout")}}return null};b.prototype.run=function(){this.httpsserver.listen(this.httpsport);this.udpserver.bind(this.udpport);return setInterval(this.tick,1E3)};return b}())(f.httpsops,f.httpsport,f.udpport,f.trackertimeout)).run()}).call(this);